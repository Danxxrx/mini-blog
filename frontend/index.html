<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mini-Blog</title>
  <style>
    :root { color-scheme: light; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #f6f7fb;
      color: #111;
    }
    .wrap { max-width: 980px; margin: 40px auto; padding: 0 16px; }
    .card {
      background: #fff;
      border-radius: 18px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,.08);
    }
    .hero h1 { margin: 0 0 6px; font-size: 44px; letter-spacing: -0.02em; }
    .hero p { margin: 0; color: #555; }
    .status { margin-top: 14px; color: #666; font-size: 14px; }
    code { background:#eee; padding:2px 6px; border-radius:6px; }
    .ok { color: #0a8a2a; font-weight: 700; }
    .err { color: #b40000; font-weight: 700; }

    .grid { margin-top: 18px; display: grid; grid-template-columns: 1fr 1.2fr; gap: 18px; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

    h2 { margin: 0 0 10px; }
    label { display:block; margin: 10px 0 6px; font-size: 13px; color:#444; }
    input, textarea {
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #e2e2e8;
      border-radius: 10px;
      padding: 12px 12px;
      font-size: 14px;
      outline: none;
      background: #fff;
    }
    textarea { min-height: 120px; resize: vertical; }
    input:focus, textarea:focus { border-color: #b8b8ff; box-shadow: 0 0 0 3px rgba(80,80,255,.12); }

    .row { display:flex; gap: 10px; align-items:center; margin-top: 12px; flex-wrap: wrap; }
    button, .linkbtn {
      border: 0;
      border-radius: 12px;
      padding: 10px 14px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .btn-primary { background: #111; color:#fff; }
    .btn-secondary { background: #fff; border: 1px solid #e2e2e8; color:#111; }
    .hint { margin-top: 10px; color:#666; font-size: 13px; }
    .msg { margin-top: 10px; font-weight: 700; }
    .msg.ok { color:#0a8a2a; }
    .msg.err { color:#b40000; }

    .postsHead { display:flex; align-items: baseline; justify-content: space-between; gap: 12px; }
    .badge { color:#666; font-size: 14px; }
    .post {
      border: 1px solid #ececf3;
      border-radius: 14px;
      padding: 16px;
      margin-top: 12px;
      background: #fff;
    }
    .postTitle { font-size: 20px; margin: 0 0 6px; }
    .postMeta { color:#666; font-size: 13px; margin: 0 0 10px; }
    .postBody { color:#333; margin: 0 0 12px; white-space: pre-wrap; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card hero">
      <h1>Mini-Blog</h1>
      <p>Udostępniaj artykuły i dołącz do dyskusji.</p>
      <div class="status">
        Backend: <code id="backendUrl">/</code> — <span id="backendState">sprawdzam…</span>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Nowy post</h2>

        <label for="title">Tytuł</label>
        <input id="title" placeholder="Np. Pierwszy wpis" />

        <label for="content">Treść</label>
        <textarea id="content" placeholder="Napisz coś…"></textarea>

        <div class="row">
          <button class="btn-primary" id="btnAdd">Dodaj post</button>
          <button class="btn-secondary" id="btnRefresh">Odśwież listę</button>
        </div>

        <div id="msg" class="msg" style="display:none;"></div>

        <div class="hint">
          Jeśli coś nie działa — sprawdź, czy server działa: <code>npm start</code> w folderze <code>backend</code>.
        </div>
      </div>

      <div class="card">
        <div class="postsHead">
          <h2>Posty</h2>
          <div class="badge" id="count">0</div>
        </div>

        <div id="posts">
          <div style="color:#666; margin-top:10px;">Brak postów. Dodaj pierwszy po lewej 👈</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API = "";

    const elBackendState = document.getElementById("backendState");
    const elBackendUrl = document.getElementById("backendUrl");
    const elTitle = document.getElementById("title");
    const elContent = document.getElementById("content");
    const elMsg = document.getElementById("msg");
    const elPosts = document.getElementById("posts");
    const elCount = document.getElementById("count");

    elBackendUrl.textContent = location.origin;
    elBackendUrl.title = location.origin;

    function showMsg(text, ok = true) {
      elMsg.style.display = "block";
      elMsg.textContent = text;
      elMsg.className = "msg " + (ok ? "ok" : "err");
      setTimeout(() => { elMsg.style.display = "none"; }, 2500);
    }

    async function checkBackend() {
      try {
        const res = await fetch(API + "/api/health");
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json().catch(() => ({}));
        elBackendState.innerHTML = '<span class="ok">OK</span> (' + (data.name || "Mini-Blog") + ')';
      } catch (e) {
        elBackendState.innerHTML = '<span class="err">BŁĄD</span> (nie działa backend)';
      }
    }

    function esc(s) {
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function renderPosts(posts) {
      elCount.textContent = posts.length;

      if (!posts.length) {
        elPosts.innerHTML = '<div style="color:#666; margin-top:10px;">Brak postów. Dodaj pierwszy po lewej 👈</div>';
        return;
      }

      elPosts.innerHTML = posts.map(p => {
        const id = p.id ?? p.PostID ?? p.postId ?? "";
        const title = esc(p.title ?? p.Title ?? "Bez tytułu");
        const content = esc(p.content ?? p.Content ?? "");
        const created = esc(p.createdAt ?? p.CreatedAt ?? p.created_at ?? "");

        return `
          <div class="post">
            <div class="postTitle">${title}</div>
            <div class="postMeta">#${esc(id)} • ${created || "—"}</div>
            <div class="postBody">${content ? content : "…"}</div>
            <div class="row">
              <a class="linkbtn btn-secondary" href="post.html?id=${encodeURIComponent(id)}">Otwórz</a>
            </div>
          </div>
        `;
      }).join("");
    }

    async function loadPosts() {
      const res = await fetch(API + "/posts");
      if (!res.ok) throw new Error("Nie mogę pobrać postów");
      const data = await res.json();
      const posts = Array.isArray(data) ? data : (data.posts ?? []);
      renderPosts(posts);
    }

    async function addPost() {
      const title = elTitle.value.trim();
      const content = elContent.value.trim();

      if (!title) {
        showMsg("Podaj tytuł.", false);
        return;
      }

      if (!content) {
        showMsg("Podaj treść.", false);
        return;
      }

      const res = await fetch(API + "/posts", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ title, content })
      });

      if (!res.ok) {
        showMsg("Nie udało się dodać posta.", false);
        return;
      }

      await loadPosts();
      elTitle.value = "";
      elContent.value = "";
      showMsg("Post dodany ✅", true);
    }

    document.getElementById("btnAdd").addEventListener("click", addPost);
    document.getElementById("btnRefresh").addEventListener("click", () => loadPosts().catch(() => {}));

    (async function init() {
      await checkBackend();
      try { await loadPosts(); } catch {}
    })();
  </script>
</body>
</html>
